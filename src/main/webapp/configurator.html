<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        let doneTypes;
        let chosenOptions = [];
        let rules;

        function onLoad() {
            let getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    let dropDown = document.getElementById("cars");
                    let response = JSON.parse(this.responseText);
                    for (let i = 0; i < response.length; i++) {
                        let current = response[i];
                        console.log(current);
                        let option = `<option value=\"${current.carId}\">${current.make} ${current.model} ${current.productionYear}</option>`
                        dropDown.innerHTML += option;
                    }
                    let url = new URL(location.href);
                    let searchParams = url.searchParams;
                    let carId = searchParams.get("carID");
                    if (carId !== null) {
                        dropDown.value = carId;
                        loadConfigurator(carId);
                    }
                }
            }
            getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars", true);
            getRequest.setRequestHeader("Accept", "application/json");
            getRequest.send();
        }


        function loadConfigurator() {
            let carId = document.getElementById("cars").value;
            console.log("configurator called for car " + carId);
            console.log(document.getElementById("cars").value);
            if (carId !== null) {
                let url = new URL(location.href);
                let searchParams = url.searchParams;
                if (searchParams.get("carID") !== carId) {
                    searchParams.delete("carID");
                    searchParams.append("carID", carId);
                    location.href = url.toString();
                }
                let getRequest = new XMLHttpRequest();
                getRequest.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        let response = JSON.parse(this.responseText);
                        let car = response.car;
                        let options = response.options;
                        rules = response.rules;
                        doneTypes = [];
                        console.log(response);
                        let carInfo = `<p>${car.make} ${car.model} ${car.productionYear}</p>`
                        document.getElementById("configurator").innerHTML = carInfo;
                        for (let i = 0; i < options.length; i++) {
                            if (!doneTypes.includes(options[i].optionType)) {
                                console.log(doneTypes);
                                optionType = options[i].optionType;
                                doneTypes.push(optionType);
                                let typeOptions = []
                                for (let n = 0; n < options.length; n++) {
                                    if (options[n].optionType === optionType) {
                                        typeOptions.push(options[n]);
                                    }
                                }
                                let optionHTML = `<h2>` + optionType + `:</h2>
                                <form id="` + optionType + `">`
                                for (let j = 0; j < typeOptions.length; j++) {
                                    let current = typeOptions[j];
                                    optionHTML += `<input id="${current.id}" name="${current.optionType}" type="checkbox" onchange="checkConfiguration(${current.id})">
                                        <label for="${current.value}">${current.value} ${current.price} - ${current.manufacturer}</label><br>`
                                }
                                optionHTML += `</form>`;
                                document.getElementById("configurator").innerHTML += optionHTML;
                            }
                        }
                    }
                }
                getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars/" + carId, true);
                getRequest.setRequestHeader("Accept", "application/json");
                getRequest.send();
            }
        }

        function checkConfiguration(id) {
            console.log("element changed " + id);
            let allowed = true;
            let checkbox = document.getElementById(id);
            console.log(checkbox.checked);
            console.log(doneTypes)
            if (checkbox.checked && !chosenOptions.includes(id)) chosenOptions.push(id);
            else chosenOptions.splice(chosenOptions.indexOf(id), 1);
            console.log(chosenOptions);
            console.log(rules);
            let relevantRules = [];
            for (let i = 0; i < rules.length; i++) {
                let rule = rules[i];
                let options = rule.options;
                if (options.includes(id)) relevantRules.push(rule);
            }
            for (let i = 0; i < relevantRules.length; i++) {
                let rule = relevantRules[i];
                let options = rule.options;
                let count = 0;
                console.log(options);
                for (let option in options) {
                    console.log(option)
                    if (chosenOptions.includes(Number.parseInt(option))) count++;
                }
                console.log(count);
                console.log(rule);
                console.log(rule.exclusive + " + " + rule.mandatory)
                if (rule.exclusive && count > 1) allowed = false;
                //if (rule.mandatory && count < 1) allowed = false;
            }
            if (!allowed) {
                console.log("illegal");
                if (!checkbox.checked) chosenOptions.splice(chosenOptions.indexOf(id), 1)
                checkbox.checked = !checkbox.checked;
                alert("Sorry, that is not allowed");
                console.log(chosenOptions);
            }
        }
    </script>
</head>
<body onload="onLoad()">
<label for="cars">Choose a car:</label>

<select name="cars" id="cars" onchange="loadConfigurator()">
    <option selected>Select a car...</option>
</select>
<div id="configurator"></div>
</body>
</html>