<!DOCTYPE html>
<html lang="en">
<head>
    <title>BetterBe - Configurator</title>
    <meta charset="UTF-8">
    <script>
        let doneTypes;
        let chosenOptions;
        let rules;
        let options;

        function onLoad() {
            let getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    let dropDown = document.getElementById("cars");
                    let response = JSON.parse(this.responseText);
                    for (let i = 0; i < response.length; i++) {
                        let current = response[i];
                        console.log(current);
                        let option = `<option value=\"${current.carId}\">${current.make} ${current.model} ${current.productionYear}</option>`
                        dropDown.innerHTML += option;
                    }
                    let url = new URL(location.href);
                    let searchParams = url.searchParams;
                    let carId = searchParams.get("carID");
                    if (carId !== null) {
                        dropDown.value = carId;
                        loadConfigurator(carId);
                    }
                }
            }
            getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars", true);
            getRequest.setRequestHeader("Accept", "application/json");
            getRequest.send();
        }


        function loadConfigurator() {
            rules = [];
            options = new Map();
            chosenOptions = [];
            doneTypes = [];
            document.title = "BetterBe - Configurator";
            document.getElementById("configurator").innerHTML = "";
            document.getElementById("total").innerHTML = "";
            document.getElementById("mandatoryCheck").innerHTML = "";
            let carId = document.getElementById("cars").value;
            console.log("configurator called for car " + carId);
            console.log(document.getElementById("cars").value);
            if (carId !== null && carId !== "null") {
                console.log("ok");
                let url = new URL(location.href);
                let searchParams = url.searchParams;
                if (searchParams.get("carID") !== carId) {
                    history.replaceState("","","?carID=" + carId);
                }
                let getRequest = new XMLHttpRequest();
                getRequest.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        let response = JSON.parse(this.responseText);
                        let car = response.car;
                        for (let i = 0; i < response.options.length; i++) {
                            let option=response.options[i];
                            options.set(option.id, option);
                        }
                        rules = response.rules;
                        doneTypes = [];
                        console.log(response);
                        let carPrice = Number(`${car.price}`);
                        let carInfo = `${car.make} ${car.model} ${car.productionYear}`;
                        let carInfoHTML = `<p>` + carInfo + ` - €` + carPrice.toFixed(2) + `</p>`;
                        document.title = "BetterBe - Configurator - " + carInfo;
                        document.getElementById("configurator").innerHTML = carInfoHTML;
                        for (let entry of options) {
                            let i = entry[0];
                            if (!doneTypes.includes(options.get(i).optionType)) {
                                console.log(doneTypes);
                                let optionType = options.get(i).optionType;
                                doneTypes.push(optionType);
                                let typeOptions = []
                                for (let entry of options) {
                                    let n = entry[0];
                                    if (options.get(n).optionType === optionType) {
                                        typeOptions.push(options.get(n));
                                    }
                                }
                                let optionHTML = `<h2>` + optionType + `:</h2>
                                <form id="` + optionType + `">`
                                for (let j = 0; j < typeOptions.length; j++) {
                                    let current = typeOptions[j];
                                    let price = Number(`${current.price}`);
                                    optionHTML += `<input id="${current.id}" name="${current.optionType}" type="checkbox" onchange="checkConfiguration(${current.id})">
                                        <label for="${current.id}">${current.value} €` + price.toFixed(2) + ` - ${current.manufacturer}</label><br>`
                                }
                                optionHTML += `</form><br>`;
                                document.getElementById("configurator").innerHTML += optionHTML;
                            }
                        }
                        document.getElementById("total").innerText = `Total Price: €` + carPrice.toFixed(2);
                        document.getElementById("mandatoryCheck").innerHTML = `<button onclick="mandatoryCheck()">Check configuration</button>`;
                    }
                }
                getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars/" + carId, true);
                getRequest.setRequestHeader("Accept", "application/json");
                getRequest.send();
            } else {
                let url = new URL(location.href);
                history.replaceState("","",url.pathname);
                console.log("yep");
            }
        }

        function checkConfiguration(id) {
            console.log("element changed " + id);
            let allowed = true;
            let checkbox = document.getElementById(id);
            console.log(checkbox.checked);
            console.log(doneTypes)
            if (!checkbox.checked) chosenOptions.splice(chosenOptions.indexOf(id), 1);
            else if (!chosenOptions.includes(id)) chosenOptions.push(id);
            console.log("chosen options:")
            console.log(chosenOptions);
            console.log(rules);
            let relevantRules = [];
            for (let i = 0; i < rules.length; i++) {
                let rule = rules[i];
                console.log(rule);
                let curOptions = rule.options;
                console.log(curOptions)
                console.log(id);
                if (curOptions.includes(id)) relevantRules.push(rule);
            }
            console.log(relevantRules);
            for (let i = 0; i < relevantRules.length; i++) {
                let rule = relevantRules[i];
                let curOptions = rule.options;
                let count = 0;
                console.log(curOptions);
                for (let i = 0; i < curOptions.length; i++) {
                    let option = curOptions[i];
                    console.log(option)
                    if (chosenOptions.includes(Number(option))) count++;
                    console.log(count);
                }
                console.log(count);
                console.log(rule);
                console.log(rule.exclusive + " + " + rule.mandatory)
                if (rule.exclusive && count > 1) allowed = false;
            }
            if (allowed) {
                let totalDiv = document.getElementById("total");
                let priceSplit = totalDiv.innerText.split("€");
                let option = options.get(id);
                let price = Number(priceSplit[1])
                if (checkbox.checked) {
                    price += option.price;
                } else {
                    price -= option.price;
                }
                totalDiv.innerText = "Total price: €" + price.toFixed(2);
                for (let i = 0; i < relevantRules.length; i++) {
                    let rule = relevantRules[i];
                    let curOptions = JSON.parse(JSON.stringify(rule.options));
                    curOptions.splice(curOptions.indexOf(id), 1);
                    for (let n = 0; n < curOptions.length; n++) {
                        console.log(checkbox.checked);
                        console.log("chang")
                        document.getElementById(curOptions[n]).disabled = checkbox.checked;
                        
                    }
                }
            } else {
                console.log("illegal");
                chosenOptions.splice(chosenOptions.indexOf(id), 1);
                checkbox.checked = !checkbox.checked;
                document.getElementById(id).disabled = true;
                alert("Sorry, that is not allowed");
                console.log(chosenOptions);
            }
        }

        function mandatoryCheck() {
            let allowed = true;
            for (let i = 0; i < rules.length; i++) {
                let rule = rules[i];
                let curOptions = rule.options;
                let count = 0;
                console.log(curOptions);
                for (let i = 0; i < curOptions.length; i++) {
                    let option = curOptions[i];
                    console.log(option)
                    if (chosenOptions.includes(Number(option))) count++;
                    console.log(count);
                }
                console.log(count);
                console.log(rule);
                console.log(rule.exclusive + " + " + rule.mandatory)
                if (rule.mandatory && count < 1) allowed = false;
            }
            if (allowed) {
                alert("legal configuration!");
            } else {
                alert("illegal configuration");
            }
        }
    </script>
</head>
<body id="body" onload="onLoad()">
<label for="cars">Choose a car:</label>

<select name="cars" id="cars" onchange="loadConfigurator()">
    <option value="null" selected>Select a car...</option>
</select>
<div id="configurator"></div>
<br>
<div id="total"></div>
<br>
<div id="mandatoryCheck"></div>
</body>
</html>