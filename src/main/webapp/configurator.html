<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BetterBe Â· Configurator</title>
    <meta name="description" content="Figma htmlGenerator">
    <meta name="author" content="htmlGenerator">
    <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="styles_configurator.css">
    <link rel="icon" href="images/bettericon.png">
    <style>
        /*
          Figma Background for illustrative/preview purposes only.
          You can remove this style tag with no consequence
        */
        body {background: #E5E5E5; }
    </style>

</head>

<body>
<div class=e41_8><span  class="e50_8">Mazda</span><span  class="e52_103">CX-9</span><span  class="e52_105">2.5 litre in-line 4 cylinder 16-valve DOHC S-VT petrol turbo engine
</span><span  class="e52_118">SUV</span><span  class="e52_119">Azami</span><span  class="e52_109">Powertrain:</span><span  class="e52_104">2021</span><span  class="e52_14">Paint</span><div  class="e46_45"></div><div class=e41_33><span  class="e41_34">Lease</span><span  class="e41_35">About</span></div><div class=e41_36><span  class="e41_37">Contact</span><span  class="e41_38">Log in</span></div><div  class="e52_13"></div><span  class="e52_15">Seats</span><div  class="e52_16"></div><div  class="e52_110"></div><span  class="e52_111">Bodytype</span><span  class="e52_116">Trim level:</span><div  class="e52_112"></div><div  class="e52_117"></div><div class=e52_26><span  class="e52_55">Black </span><span  class="e52_58">details</span><div  class="e52_28"></div><div  class="e52_17"></div></div><div class=e52_60><span  class="e52_61">White</span><span  class="e52_62">details</span><div  class="e52_63"></div><div  class="e52_64"></div></div><div class=e52_65><span  class="e52_66">Blue</span><span  class="e52_67">details</span><div  class="e52_68"></div><div  class="e52_69"></div></div><div class=e52_85><span  class="e52_86">Black </span><span  class="e52_87">details</span><div  class="e52_88"></div><div  class="e52_89"></div></div><div class=e52_90><span  class="e52_91">White</span><span  class="e52_92">details</span><div  class="e52_93"></div><div  class="e52_94"></div></div><div class=e52_95><span  class="e52_96">Blue</span><span  class="e52_97">details</span><div  class="e52_98"></div><div  class="e52_99"></div></div></div>
</body>

    <script>
        let doneTypes;
        let chosenOptions = [];
        let rules;

        function onLoad() {
            let getRequest = new XMLHttpRequest();
            getRequest.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    let dropDown = document.getElementById("cars");
                    let response = JSON.parse(this.responseText);
                    for (let i = 0; i < response.length; i++) {
                        let current = response[i];
                        console.log(current);
                        let option = `<option value=\"${current.carId}\">${current.make} ${current.model} ${current.productionYear}</option>`
                        dropDown.innerHTML += option;
                    }
                    let url = new URL(location.href);
                    let searchParams = url.searchParams;
                    let carId = searchParams.get("carID");
                    if (carId !== null) {
                        dropDown.value = carId;
                        loadConfigurator(carId);
                    }
                }
            }
            getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars", true);
            getRequest.setRequestHeader("Accept", "application/json");
            getRequest.send();
        }


        function loadConfigurator() {
            let carId = document.getElementById("cars").value;
            console.log("configurator called for car " + carId);
            console.log(document.getElementById("cars").value);
            if (carId !== null) {
                let url = new URL(location.href);
                let searchParams = url.searchParams;
                if (searchParams.get("carID") !== carId) {
                    searchParams.delete("carID");
                    searchParams.append("carID", carId);
                    location.href = url.toString();
                }
                let getRequest = new XMLHttpRequest();
                getRequest.onreadystatechange = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        let response = JSON.parse(this.responseText);
                        let car = response.car;
                        let options = response.options;
                        rules = response.rules;
                        doneTypes = [];
                        console.log(response);
                        let carInfo = `<p>${car.make} ${car.model} ${car.productionYear}</p>`
                        document.getElementById("configurator").innerHTML = carInfo;
                        for (let i = 0; i < options.length; i++) {
                            if (!doneTypes.includes(options[i].optionType)) {
                                console.log(doneTypes);
                                optionType = options[i].optionType;
                                doneTypes.push(optionType);
                                let typeOptions = []
                                for (let n = 0; n < options.length; n++) {
                                    if (options[n].optionType === optionType) {
                                        typeOptions.push(options[n]);
                                    }
                                }
                                let optionHTML = `<h2>` + optionType + `:</h2>
                                <form id="` + optionType + `">`
                                for (let j = 0; j < typeOptions.length; j++) {
                                    let current = typeOptions[j];
                                    optionHTML += `<input id="${current.id}" name="${current.optionType}" type="checkbox" onchange="checkConfiguration(${current.id})">
                                        <label for="${current.value}">${current.value} ${current.price} - ${current.manufacturer}</label><br>`
                                }
                                optionHTML += `</form>`;
                                document.getElementById("configurator").innerHTML += optionHTML;
                            }
                        }
                    }
                }
                getRequest.open("GET", "http://localhost:8080/betterbe_3/rest/cars/" + carId, true);
                getRequest.setRequestHeader("Accept", "application/json");
                getRequest.send();
            }
        }

        function checkConfiguration(id) {
            console.log("element changed " + id);
            let allowed = true;
            console.log(doneTypes)
            chosenOptions.push(id);
            console.log(chosenOptions);
            console.log(rules);
            for (let rule in rules) {
                let options = rule.options;
                let count = 0;
                for (let option in options) {
                    if (chosenOptions.includes(option)) count++;
                }
                if (rule.exclusive && count > 1) allowed = false;
                if (rule.mandatory && count < 1) allowed = false;
            }
            if (!allowed) {
                console.log("illegal");
                let mistake = document.getElementById(id);
                mistake.checked = !mistake.checked;
                alert("Sorry, that is not allowed");
            }
        }
    </script>
</head>
<body id="body" onload="onLoad()">
<label for="cars">Choose a car:</label>

<select name="cars" id="cars" onchange="loadConfigurator()">
    <option selected>Select a car...</option>
</select>
<div id="configurator"></div>
</body>
</html>